<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grimoire Reader — Strange Historicism TTS</title>
<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<!-- PDF.js (CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.mjs" type="module" id="pdfjs-module"></script>
<style>
  :root{
    --ink:#0f1113;          /* neo-brutal ink */
    --bg:#f7f5ef;           /* parchment */
    --card:#fffdf6;         /* lighter parchment */
    --line:#0f1113;         /* thick brutal lines */
    --accent:#05ffd2;       /* cyberpunk mint */
    --accent2:#ff2bd6;      /* cyberpunk magenta */
    --shadow: 6px 6px 0 #0f1113; /* hard shadow */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:16px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }
  header{
    display:flex; align-items:center; gap:16px; padding:18px 22px; border-bottom:4px solid var(--line);
    background:linear-gradient(180deg, #fffdf7 0%, #f5f1e6 100%);
    position:sticky; top:0; z-index:10;
  }
  .logo{display:flex; align-items:center; gap:12px}
  .logo .sigil{
    width:54px; height:54px; background:var(--card); border:4px solid var(--line); box-shadow:var(--shadow); display:grid; place-items:center;
  }
  .logo .sigil svg{width:38px; height:38px}
  .title{
    font-family:'UnifrakturCook', serif; font-size:34px; letter-spacing:0.5px; line-height:1;
  }
  main{max-width:1200px; margin:24px auto; padding:0 18px 72px}
  .grid{display:grid; grid-template-columns: 1.1fr 0.9fr; gap:24px}

  .panel{
    background:var(--card); border:4px solid var(--line); box-shadow:var(--shadow); padding:18px; position:relative;
  }
  .panel h2{margin:0 0 8px 0; font:800 18px/1.1 Inter, sans-serif; letter-spacing:0.2px}
  .panel .sub{color:#444; font-size:13px; margin-bottom:14px}

  .dropzone{
    border:4px dashed var(--line); padding:18px; background:#fff; cursor:pointer; user-select:none;
    display:flex; align-items:center; justify-content:center; min-height:140px; text-align:center; position:relative;
  }
  .dropzone:after{
    content:"Drag & drop PDF/TXT here — or click to select"; font-weight:800; letter-spacing:0.3px;
  }
  .dropzone.drag{outline:6px solid var(--accent); background:#f2fff9}

  textarea#text{width:100%; min-height:320px; resize:vertical; border:4px solid var(--line); padding:12px; font:14px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}

  .controls{display:grid; gap:12px; grid-template-columns:1fr 1fr;}
  .controls .row{display:flex; gap:12px; align-items:center}
  .controls label{font-weight:800}
  select, input[type="range"], button{
    border:4px solid var(--line); background:#fff; padding:10px 12px; font-weight:800; letter-spacing:0.3px;
  }
  button{cursor:pointer; box-shadow:var(--shadow)}
  button.primary{background:var(--accent);}
  button.warn{background:#ffe269}
  button.stop{background:#ffd3d3}

  .neon{
    position:absolute; inset:auto 12px 12px auto; font-weight:800; padding:6px 10px; border:4px solid var(--line);
    background:linear-gradient(90deg, var(--accent), var(--accent2)); color:#000; box-shadow:var(--shadow);
  }

  .meter{display:flex; align-items:center; gap:12px; margin-top:8px}
  .bar{flex:1; height:12px; border:4px solid var(--line); background:#fff; position:relative}
  .bar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2));}

  .readout{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:12px}
  .chip{border:4px solid var(--line); background:#fff; padding:10px; font-weight:800; text-align:center}
  .chip small{display:block; font-weight:600; color:#333}

  .content-preview{border:4px solid var(--line); padding:12px; background:#fff; font-size:15px; line-height:1.5; max-height:480px; overflow:auto}
  .content-preview mark{background: #fffd8a; padding:0 2px}

  .footnote{margin-top:16px; font-size:12px; color:#333}

  /* Medieval ornament divider */
  .divider{height:20px; background:repeating-linear-gradient(90deg, #000 0 8px, transparent 8px 16px)}

  @media (max-width: 920px){
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header>
  <div class="logo">
    <div class="sigil" aria-hidden="true">
      <!-- Woodcut-ish griffin sigil -->
      <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10 54h44M10 10h16l6 7 6-7h16v12l-6 5 6 5v12H38l-6 7-6-7H10V32l6-5-6-5V10Z" stroke="#0f1113" stroke-width="4" fill="#fff"/>
        <path d="M26 22c3 2 9 2 12 0m-18 6c4 3 20 3 24 0m-22 6c3 2 17 2 20 0" stroke="#0f1113" stroke-width="4"/>
      </svg>
    </div>
    <div class="title">Grimoire Reader</div>
  </div>
  <div class="neon" title="A little cyberpunk flair">CYBER • CHANT</div>
</header>
<main>
  <div class="grid">
    <section class="panel" aria-label="Document Ingestion">
      <h2>1) Ingest your scroll</h2>
      <div class="sub">Drop a PDF (export from Google Docs) or paste text below. We parse the pages and prep for narration.</div>

      <input id="file" type="file" accept=".pdf,.txt" hidden>
      <div id="dropzone" class="dropzone" role="button" tabindex="0" aria-label="Drop or select file"></div>

      <div class="divider" style="margin:14px 0"></div>

      <label for="text" style="font-weight:800;">Or paste text</label>
      <textarea id="text" placeholder="Paste your doc text here if you don't have a PDF..."></textarea>

      <div class="meter" aria-label="Document size">
        <div class="bar" aria-hidden="true"><i id="fill"></i></div>
        <div id="wordCount" style="font-weight:800; min-width:90px; text-align:right">0 words</div>
      </div>

      <div class="readout">
        <div class="chip"><small>Est. duration</small><span id="eta">—</span></div>
        <div class="chip"><small>Reading rate</small><span><span id="wpm">160</span> wpm</span></div>
        <div class="chip"><small>Sections</small><span id="segments">0</span></div>
      </div>

      <div class="footnote">Tip: For Google Docs, use <strong>File → Download → PDF</strong>, then drop it here. English only for now.</div>
    </section>

    <section class="panel" aria-label="Narration Controls">
      <h2>2) Conjure the narrator</h2>
      <div class="sub">Pick a voice, set speed, then cast <em>Speak</em>. Pause/Resume won’t lose your place.</div>

      <div class="controls" style="margin-bottom:12px">
        <div class="row" style="grid-column:1/-1">
          <label for="voiceMale">Voices</label>
          <select id="voiceMale" title="Male Voices"></select>
          <select id="voiceFemale" title="Female Voices"></select>
        </div>
        <div class="row" style="grid-column:1/-1">
          <label for="rate">Speed</label>
          <input id="rate" type="range" min="0.5" max="2.0" step="0.05" value="1"/>
          <div style="font-weight:800; width:68px; text-align:right"><span id="rateVal">1.00×</span></div>
        </div>
        <div class="row" style="grid-column:1/-1; gap:10px">
          <button id="speak" class="primary">▶ Speak</button>
          <button id="pause" class="warn">⏸ Pause</button>
          <button id="resume" class="primary">⏯ Resume</button>
          <button id="stop" class="stop">⏹ Stop</button>
        </div>
      </div>

      <div class="content-preview" id="preview" aria-live="polite" aria-label="Reading preview (current sentence highlighted)"></div>

      <div class="footnote">Browser voices vary. We auto-pick 2F + 2M English options when available. Use the dropdowns to choose.</div>
    </section>
  </div>
</main>

<script type="module">
  /* -------------------------------------------------------
     STRANGE HISTORICISM TTS — Single-file GitHub-friendly
     Features:
     - PDF/TXT ingest (PDF via pdf.js)
     - Web Speech Synthesis (English voices)
     - 2x voice selects (aiming for M/F variants)
     - Rate control, Pause/Resume/Stop
     - Duration estimate (podcast-style)
     - Sentence-level highlighting & progress
  ------------------------------------------------------- */

  // PDF.js via module (already loaded by script tag above)
  const pdfjsScript = document.getElementById('pdfjs-module');
  let pdfjsLib = null;
  if (pdfjsScript && pdfjsScript.type === 'module') {
    // dynamic import of the same CDN to access pdfjsLib namespace
    const mod = await import('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.mjs');
    pdfjsLib = mod;
  }

  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('file');
  const textArea = document.getElementById('text');
  const fill = document.getElementById('fill');
  const wordCount = document.getElementById('wordCount');
  const eta = document.getElementById('eta');
  const wpmOut = document.getElementById('wpm');
  const segmentsOut = document.getElementById('segments');
  const preview = document.getElementById('preview');

  const rate = document.getElementById('rate');
  const rateVal = document.getElementById('rateVal');
  const speakBtn = document.getElementById('speak');
  const pauseBtn = document.getElementById('pause');
  const resumeBtn = document.getElementById('resume');
  const stopBtn = document.getElementById('stop');

  const voiceMaleSel = document.getElementById('voiceMale');
  const voiceFemaleSel = document.getElementById('voiceFemale');

  // State
  let fullText = '';
  let sentences = [];
  let currentIndex = 0;
  let speaking = false;
  let baseWPM = 160; // natural podcast-y baseline
  let selectedVoiceMale = null;
  let selectedVoiceFemale = null;
  let usingVoice = 'male'; // toggle based on last changed select

  // Helpers
  const splitIntoSentences = (txt) => {
    // A pragmatic sentence splitter
    return txt
      .replace(/\s+/g, ' ')
      .split(/(?<=[.!?])\s+(?=[A-Z0-9\(\"\'])/)
      .filter(Boolean);
  };

  const updateStats = () => {
    const wc = (fullText.match(/\b\w+\b/g) || []).length;
    wordCount.textContent = wc + ' words';
    const slider = parseFloat(rate.value);
    const effectiveWPM = Math.round(baseWPM * slider);
    wpmOut.textContent = effectiveWPM;
    const minutes = wc / effectiveWPM;
    const mm = Math.floor(minutes);
    const ss = Math.round((minutes - mm) * 60);
    eta.textContent = (mm>0? mm+ 'm ':'') + ss + 's';
    segmentsOut.textContent = sentences.length.toString();
    // progress bar is reset until reading begins
    fill.style.width = '0%';
  };

  const renderPreview = () => {
    const before = sentences.slice(Math.max(0, currentIndex-3), currentIndex).join(' ');
    const current = sentences[currentIndex] || '';
    const after = sentences.slice(currentIndex+1, currentIndex+6).join(' ');
    preview.innerHTML = `${before ? before + ' ' : ''}<mark>${current}</mark> ${after}`;
    // progress
    const pct = sentences.length ? (currentIndex / sentences.length) * 100 : 0;
    fill.style.width = pct.toFixed(1) + '%';
  };

  // Voice setup
  function listVoices() {
    const voices = window.speechSynthesis.getVoices().filter(v => /en(-|_|\b)/i.test(v.lang));
    // naive gender guess by name/label
    const female = voices.filter(v => /(female|samantha|victoria|karen|serena|microsoft aria|google uk english female|english \(india\)) /i.test(v.name + ' ' + (v.voiceURI||'')) || /female/i.test(v.voiceURI||''));
    const male = voices.filter(v => /(male|daniel|alex|fred|microsoft guy|google uk english male|english \(us\)*/i.test(v.name + ' ' + (v.voiceURI||'')) || /male/i.test(v.voiceURI||''));

    // Fallbacks: if not enough, just fill from all voices
    const ensureN = (arr, n, pool) => {
      const copy = [...arr];
      for (const v of pool) { if (copy.length >= n) break; if (!copy.includes(v)) copy.push(v); }
      return copy.slice(0, n);
    };

    const female2 = ensureN(female, 2, voices);
    const male2 = ensureN(male, 2, voices);

    const optify = (sel, arr) => {
      sel.innerHTML = '';
      arr.forEach((v, i) => {
        const o = document.createElement('option');
        o.value = v.name;
        o.textContent = `${v.name} (${v.lang})`;
        if (i===0) o.selected = true;
        sel.appendChild(o);
      });
      if (arr[0]) return arr[0];
      return voices[0] || null;
    };

    selectedVoiceFemale = optify(voiceFemaleSel, female2);
    selectedVoiceMale   = optify(voiceMaleSel, male2);
  }

  window.speechSynthesis.onvoiceschanged = listVoices;
  // initial try
  setTimeout(listVoices, 300);

  voiceMaleSel.addEventListener('change', () => { usingVoice = 'male'; });
  voiceFemaleSel.addEventListener('change', () => { usingVoice = 'female'; });

  // File ingest (PDF/TXT)
  dropzone.addEventListener('click', () => fileInput.click());
  dropzone.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') fileInput.click(); });

  const handleFiles = async (file) => {
    if (!file) return;
    if (file.type === 'text/plain') {
      const txt = await file.text();
      textArea.value = txt;
      fullText = txt;
      sentences = splitIntoSentences(fullText);
      updateStats();
      renderPreview();
      return;
    }
    if (/pdf/i.test(file.type)) {
      if (!pdfjsLib) { alert('PDF parser failed to load. Try pasting text instead.'); return; }
      const url = URL.createObjectURL(file);
      try{
        const pdf = await pdfjsLib.getDocument(url).promise;
        let out = '';
        for (let p=1; p<=pdf.numPages; p++){
          const page = await pdf.getPage(p);
          const content = await page.getTextContent();
          const str = content.items.map(it => it.str).join(' ');
          out += str + '\n\n';
        }
        URL.revokeObjectURL(url);
        textArea.value = out.trim();
        fullText = textArea.value;
        sentences = splitIntoSentences(fullText);
        updateStats();
        renderPreview();
      }catch(err){
        console.error(err); alert('Could not parse PDF. Try exporting a simpler text-based PDF or paste the text.');
      }
      return;
    }
    alert('Unsupported file. Use PDF or TXT.');
  };

  fileInput.addEventListener('change', (e) => handleFiles(e.target.files[0]));

  ['dragenter','dragover'].forEach(ev=>dropzone.addEventListener(ev, (e)=>{e.preventDefault(); dropzone.classList.add('drag');}));
  ;['dragleave','drop'].forEach(ev=>dropzone.addEventListener(ev, (e)=>{e.preventDefault(); dropzone.classList.remove('drag');}));
  dropzone.addEventListener('drop', (e)=>{
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    handleFiles(f);
  });

  // Text area live stats
  textArea.addEventListener('input', () => {
    fullText = textArea.value;
    sentences = splitIntoSentences(fullText);
    updateStats();
    renderPreview();
  });

  // Rate control
  rate.addEventListener('input', () => {
    rateVal.textContent = parseFloat(rate.value).toFixed(2) + '×';
    updateStats();
  });

  // Speech Engine
  const getSelectedVoice = () => {
    const voices = window.speechSynthesis.getVoices();
    const maleName = voiceMaleSel.value;
    const femaleName = voiceFemaleSel.value;
    const pick = usingVoice === 'female' ? femaleName : maleName;
    return voices.find(v => v.name === pick) || voices[0] || null;
  };

  const speakSentence = (text) => new Promise((resolve, reject) => {
    const u = new SpeechSynthesisUtterance(text);
    const v = getSelectedVoice();
    if (v) u.voice = v;
    u.rate = parseFloat(rate.value);
    u.lang = (v && v.lang) || 'en-US';
    u.onend = resolve;
    u.onerror = (e) => { console.error(e); resolve(); };
    window.speechSynthesis.speak(u);
  });

  const speakAll = async () => {
    if (!sentences.length) { alert('Add some text or a PDF first.'); return; }
    if (speaking) return; // prevent double start
    speaking = true;
    while (speaking && currentIndex < sentences.length) {
      renderPreview();
      // Queue a chunk (cap very long sentences)
      const chunk = sentences[currentIndex].trim();
      await speakSentence(chunk);
      if (!speaking) break;
      currentIndex++;
    }
    speaking = false;
    renderPreview();
  };

  speakBtn.addEventListener('click', () => {
    if (!fullText.trim()) { alert('Please add content first.'); return; }
    // If starting fresh (stopped), reset highlight
    if (!speaking && window.speechSynthesis.paused === false && currentIndex === 0) {
      renderPreview();
    }
    if (window.speechSynthesis.paused) {
      window.speechSynthesis.resume();
    }
    speakAll();
  });

  pauseBtn.addEventListener('click', () => {
    if (window.speechSynthesis.speaking && !window.speechSynthesis.paused) {
      window.speechSynthesis.pause();
    }
  });

  resumeBtn.addEventListener('click', () => {
    if (window.speechSynthesis.paused) {
      window.speechSynthesis.resume();
    }
  });

  stopBtn.addEventListener('click', () => {
    speaking = false;
    window.speechSynthesis.cancel();
    currentIndex = 0;
    renderPreview();
  });

  // Persist cursor on unload stop
  window.addEventListener('beforeunload', () => window.speechSynthesis.cancel());

  // Accessibility: allow space/enter to trigger primary action on focused buttons
  document.addEventListener('keydown', (e) => {
    const isButton = document.activeElement && document.activeElement.tagName === 'BUTTON';
    if (isButton && (e.key === 'Enter' || e.key === ' ')) {
      document.activeElement.click();
    }
  });

  // Initialize preview
  renderPreview();
  updateStats();
</script>
</body>
</html>
