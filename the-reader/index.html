<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grimoire Reader — Strange Historicism TTS (v1.1)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{ --ink:#0f1113; --bg:#f7f5ef; --card:#fffdf6; --line:#0f1113; --accent:#05ffd2; --accent2:#ff2bd6; --shadow:6px 6px 0 #0f1113 }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{display:flex;align-items:center;gap:16px;padding:18px 22px;border-bottom:4px solid var(--line);background:linear-gradient(180deg,#fffdf7 0%,#f5f1e6 100%);position:sticky;top:0;z-index:10}
  .logo{display:flex;align-items:center;gap:12px}
  .logo .sigil{width:54px;height:54px;background:var(--card);border:4px solid var(--line);box-shadow:var(--shadow);display:grid;place-items:center}
  .logo .sigil svg{width:38px;height:38px}
  .title{font-family:'UnifrakturCook',serif;font-size:34px;letter-spacing:.5px;line-height:1}
  main{max-width:1200px;margin:24px auto;padding:0 18px 72px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:24px}
  .panel{background:var(--card);border:4px solid var(--line);box-shadow:var(--shadow);padding:18px;position:relative}
  .panel h2{margin:0 0 8px 0;font:800 18px/1.1 Inter, sans-serif;letter-spacing:.2px}
  .panel .sub{color:#444;font-size:13px;margin-bottom:14px}
  .dropzone{border:4px dashed var(--line);padding:18px;background:#fff;cursor:pointer;user-select:none;display:flex;align-items:center;justify-content:center;min-height:140px;text-align:center;position:relative}
  .dropzone:after{content:"Drag & drop PDF/TXT here — or click to select";font-weight:800;letter-spacing:.3px}
  .dropzone.drag{outline:6px solid var(--accent);background:#f2fff9}
  textarea#text{width:100%;min-height:320px;resize:vertical;border:4px solid var(--line);padding:12px;font:14px/1.4 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
  .controls{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .controls .row{display:flex;gap:12px;align-items:center}
  .controls label{font-weight:800}
  select,input[type="range"],button{border:4px solid var(--line);background:#fff;padding:10px 12px;font-weight:800;letter-spacing:.3px}
  button{cursor:pointer;box-shadow:var(--shadow)}
  button.primary{background:var(--accent)}
  button.warn{background:#ffe269}
  button.stop{background:#ffd3d3}
  .neon{position:absolute;inset:auto 12px 12px auto;font-weight:800;padding:6px 10px;border:4px solid var(--line);background:linear-gradient(90deg,var(--accent),var(--accent2));color:#000;box-shadow:var(--shadow)}
  .meter{display:flex;align-items:center;gap:12px;margin-top:8px}
  .bar{flex:1;height:12px;border:4px solid var(--line);background:#fff;position:relative}
  .bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .readout{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
  .chip{border:4px solid var(--line);background:#fff;padding:10px;font-weight:800;text-align:center}
  .chip small{display:block;font-weight:600;color:#333}
  .content-preview{border:4px solid var(--line);padding:12px;background:#fff;font-size:15px;line-height:1.5;max-height:480px;overflow:auto}
  .content-preview mark{background:#fffd8a;padding:0 2px}
  .footnote{margin-top:16px;font-size:12px;color:#333}
  .divider{height:20px;background:repeating-linear-gradient(90deg,#000 0 8px,transparent 8px 16px)}
  @media (max-width:920px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div class="logo">
    <div class="sigil" aria-hidden="true">
      <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 54h44M10 10h16l6 7 6-7h16v12l-6 5 6 5v12H38l-6 7-6-7H10V32l6-5-6-5V10Z" stroke="#0f1113" stroke-width="4" fill="#fff"/><path d="M26 22c3 2 9 2 12 0m-18 6c4 3 20 3 24 0m-22 6c3 2 17 2 20 0" stroke="#0f1113" stroke-width="4"/></svg>
    </div>
    <div class="title">Grimoire Reader</div>
  </div>
  <div class="neon" title="A little cyberpunk flair">CYBER • CHANT</div>
</header>
<main>
  <div class="grid">
    <section class="panel" aria-label="Document Ingestion">
      <h2>1) Ingest your scroll</h2>
      <div class="sub">Drop a PDF (export from Google Docs) or paste text below. We parse the pages and prep for narration.</div>
      <input id="file" type="file" accept=".pdf,.txt" hidden>
      <div id="dropzone" class="dropzone" role="button" tabindex="0" aria-label="Drop or select file"></div>
      <div class="divider" style="margin:14px 0"></div>
      <label for="text" style="font-weight:800;">Or paste text</label>
      <textarea id="text" placeholder="Paste your doc text here if you don't have a PDF..."></textarea>
      <div class="meter" aria-label="Document size">
        <div class="bar" aria-hidden="true"><i id="fill"></i></div>
        <div id="wordCount" style="font-weight:800;min-width:90px;text-align:right">0 words</div>
      </div>
      <div class="readout">
        <div class="chip"><small>Est. duration</small><span id="eta">—</span></div>
        <div class="chip"><small>Reading rate</small><span><span id="wpm">160</span> wpm</span></div>
        <div class="chip"><small>Sections</small><span id="segments">0</span></div>
      </div>
      <div class="footnote">Tip: For Google Docs, use <strong>File → Download → PDF</strong>, then drop it here. English only for now.</div>
    </section>
    <section class="panel" aria-label="Narration Controls">
      <h2>2) Conjure the narrator</h2>
      <div class="sub">Pick a voice, set speed, then cast <em>Speak</em>. Pause/Resume won’t lose your place.</div>
      <div class="controls" style="margin-bottom:12px">
        <div class="row" style="grid-column:1/-1">
          <label for="voiceMale">Voices</label>
          <select id="voiceMale" title="Male Voices"></select>
          <select id="voiceFemale" title="Female Voices"></select>
        </div>
        <div class="row" style="grid-column:1/-1">
          <label for="rate">Speed</label>
          <input id="rate" type="range" min="0.5" max="2.0" step="0.05" value="1"/>
          <div style="font-weight:800;width:68px;text-align:right"><span id="rateVal">1.00×</span></div>
        </div>
        <div class="row" style="grid-column:1/-1;gap:10px">
          <button id="speak" class="primary">▶ Speak</button>
          <button id="pause" class="warn">⏸ Pause</button>
          <button id="resume" class="primary">⏯ Resume</button>
          <button id="stop" class="stop">⏹ Stop</button>
        </div>
      </div>
      <div class="content-preview" id="preview" aria-live="polite" aria-label="Reading preview (current sentence highlighted)"></div>
      <div class="footnote">Browser voices vary. We auto-pick 2F + 2M English options when available. Use the dropdowns to choose.</div>
    </section>
  </div>
</main>

<script type="module">
  // State & elements
  let pdfjsLib = null; // lazy-loaded when a PDF is handled
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('file');
  const textArea = document.getElementById('text');
  const fill = document.getElementById('fill');
  const wordCount = document.getElementById('wordCount');
  const eta = document.getElementById('eta');
  const wpmOut = document.getElementById('wpm');
  const segmentsOut = document.getElementById('segments');
  const preview = document.getElementById('preview');
  const rate = document.getElementById('rate');
  const rateVal = document.getElementById('rateVal');
  const speakBtn = document.getElementById('speak');
  const pauseBtn = document.getElementById('pause');
  const resumeBtn = document.getElementById('resume');
  const stopBtn = document.getElementById('stop');
  const voiceMaleSel = document.getElementById('voiceMale');
  const voiceFemaleSel = document.getElementById('voiceFemale');

  let fullText = '';
  let sentences = [];
  let currentIndex = 0;
  let speaking = false;
  let baseWPM = 160;
  let usingVoice = 'male';

  const splitIntoSentences = (txt) => txt.replace(/\s+/g,' ').split(/(?<=[.!?])\s+(?=[A-Z0-9\(\"\'])/).filter(Boolean);

  const updateStats = () => {
    const wc = (fullText.match(/\b\w+\b/g) || []).length;
    wordCount.textContent = wc + ' words';
    const slider = parseFloat(rate.value || '1');
    const effectiveWPM = Math.max(80, Math.round(baseWPM * slider));
    wpmOut.textContent = effectiveWPM;
    const minutes = wc / effectiveWPM; const mm = Math.floor(minutes); const ss = Math.max(0, Math.round((minutes-mm)*60));
    eta.textContent = (mm>0? mm+'m ' : '') + ss + 's';
    segmentsOut.textContent = sentences.length.toString();
    if (!speaking) fill.style.width = '0%';
  };

  const renderPreview = () => {
    const before = sentences.slice(Math.max(0,currentIndex-3), currentIndex).join(' ');
    const current = sentences[currentIndex] || '';
    const after = sentences.slice(currentIndex+1, currentIndex+6).join(' ');
    preview.innerHTML = `${before ? before+' ' : ''}<mark>${current}</mark> ${after}`;
    const pct = sentences.length ? (currentIndex / sentences.length) * 100 : 0;
    fill.style.width = pct.toFixed(1)+'%';
  };

  // -------- voices --------
  function listVoices(){
    const all = (window.speechSynthesis.getVoices && window.speechSynthesis.getVoices())?.filter(v=>/en(-|_|\b)/i.test(v.lang)) || [];
    const guessF = v => /(female|samantha|victoria|karen|serena|aria|zoe|sara|fem)/i.test(`${v.name} ${v.voiceURI}`);
    const guessM = v => /(male|daniel|alex|fred|george|guy|brian|mal)/i.test(`${v.name} ${v.voiceURI}`);
    const females = all.filter(guessF); const males = all.filter(guessM);
    const ensureN=(arr,n,pool)=>{const c=[...arr]; for(const v of pool){if(c.length>=n)break; if(!c.includes(v))c.push(v);} return c.slice(0,n)};
    const female2 = ensureN(females,2,all); const male2=ensureN(males,2,all);
    const fillSel=(sel,arr)=>{ sel.innerHTML=''; arr.forEach((v,i)=>{ const o=document.createElement('option'); o.value=v.name; o.textContent=`${v.name} (${v.lang})`; if(i===0)o.selected=true; sel.appendChild(o); }); if(!arr.length && all.length){ const o=document.createElement('option'); o.value=all[0].name; o.textContent=`${all[0].name} (${all[0].lang})`; sel.appendChild(o);} };
    fillSel(voiceFemaleSel,female2); fillSel(voiceMaleSel,male2);
  }
  const tryVoices=()=>{ listVoices(); if(!voiceFemaleSel.options.length && !voiceMaleSel.options.length){ let tries=0; const iv=setInterval(()=>{ listVoices(); tries++; if(voiceFemaleSel.options.length||voiceMaleSel.options.length||tries>10) clearInterval(iv); },300); } };
  if('speechSynthesis' in window){ window.speechSynthesis.onvoiceschanged=listVoices; tryVoices(); } else { alert('This browser does not support Speech Synthesis. Try Chrome or Edge.'); }
  voiceMaleSel.addEventListener('change',()=>{ usingVoice='male'; });
  voiceFemaleSel.addEventListener('change',()=>{ usingVoice='female'; });

  // -------- file ingest --------
  dropzone.addEventListener('click', ()=>fileInput.click());
  dropzone.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' ') fileInput.click(); });
  async function ensurePdfLib(){ if(pdfjsLib) return pdfjsLib; try{ const mod = await import('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.mjs'); pdfjsLib = mod; return pdfjsLib; }catch(e){ console.error('PDF.js import failed',e); alert('Could not load PDF parser. Paste text instead or try another browser.'); return null; } }
  const handleFiles = async (file)=>{
    if(!file) return;
    if(file.type==='text/plain'){
      const txt=await file.text(); textArea.value=txt; fullText=txt; sentences=splitIntoSentences(fullText); updateStats(); renderPreview(); return; }
    if(/pdf/i.test(file.type)){
      const lib=await ensurePdfLib(); if(!lib) return; const url=URL.createObjectURL(file);
      try{ const pdf=await lib.getDocument(url).promise; let out=''; for(let p=1;p<=pdf.numPages;p++){ const page=await pdf.getPage(p); const content=await page.getTextContent(); const str=content.items.map(it=>it.str).join(' '); out+=str+'\n\n'; } URL.revokeObjectURL(url); textArea.value=out.trim(); fullText=textArea.value; sentences=splitIntoSentences(fullText); updateStats(); renderPreview(); }catch(err){ console.error(err); alert('Could not parse PDF. Try a text-based export or paste the text.'); }
      return; }
    alert('Unsupported file. Use PDF or TXT.'); };
  fileInput.addEventListener('change',(e)=>handleFiles(e.target.files[0]));
  ['dragenter','dragover'].forEach(ev=>dropzone.addEventListener(ev,(e)=>{e.preventDefault(); dropzone.classList.add('drag');}));
  ;['dragleave','drop'].forEach(ev=>dropzone.addEventListener(ev,(e)=>{e.preventDefault(); dropzone.classList.remove('drag');}));
  dropzone.addEventListener('drop',(e)=>{ const f=e.dataTransfer.files && e.dataTransfer.files[0]; handleFiles(f); });

  // text live stats
  const recalc=()=>{ fullText=textArea.value; sentences=splitIntoSentences(fullText); updateStats(); renderPreview(); };
  textArea.addEventListener('input',recalc); textArea.addEventListener('paste',()=>setTimeout(recalc,0));

  // -------- speech engine --------
  const getSelectedVoice=()=>{ const voices=window.speechSynthesis.getVoices(); const pick=usingVoice==='female'? voiceFemaleSel.value : voiceMaleSel.value; return voices.find(v=>v.name===pick)||voices[0]||null; };
  const speakSentence=(text)=>new Promise((resolve)=>{ const u=new SpeechSynthesisUtterance(text); const v=getSelectedVoice(); if(v) u.voice=v; u.rate=parseFloat(rate.value||'1'); u.lang=(v&&v.lang)||'en-US'; u.onend=resolve; u.onerror=(e)=>{ console.error(e); resolve(); }; window.speechSynthesis.speak(u); });
  const speakAll=async()=>{ if(!sentences.length){ alert('Add some text or a PDF first.'); return; } if(speaking) return; speaking=true; while(speaking && currentIndex<sentences.length){ renderPreview(); const chunk=sentences[currentIndex].trim(); await speakSentence(chunk); if(!speaking) break; currentIndex++; } speaking=false; renderPreview(); };
  speakBtn.addEventListener('click',()=>{ if(!('speechSynthesis' in window)){ alert('Speech Synthesis unsupported. Try Chrome/Edge.'); return; } if(!textArea.value.trim() && !fullText.trim()){ alert('Please add content first.'); return; } if(!sentences.length) recalc(); if(window.speechSynthesis.paused) window.speechSynthesis.resume(); speakAll(); });
  pauseBtn.addEventListener('click',()=>{ if(window.speechSynthesis.speaking && !window.speechSynthesis.paused) window.speechSynthesis.pause(); });
  resumeBtn.addEventListener('click',()=>{ if(window.speechSynthesis.paused) window.speechSynthesis.resume(); });
  stopBtn.addEventListener('click',()=>{ speaking=false; window.speechSynthesis.cancel(); currentIndex=0; renderPreview(); });
  rate.addEventListener('input',()=>{ rateVal.textContent=parseFloat(rate.value||'1').toFixed(2)+'×'; updateStats(); });

  // init
  renderPreview(); updateStats();
</script>
</body>
</html>
